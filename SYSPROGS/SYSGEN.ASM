;SYSGEN - Copies System 

;D. LAUSBERG	(C) 2021
;V1.0	15.05.21


VERSION	= $10		;VERSION NUMBER


;FORMAT	DS/DD	320 KBYTES/DISK
;16 SEKTOREN/TRACK	256 BYTES/SEKTOR
;80 TRACKS/DISK
;DEPENDING ON BIOS > 2.2
;=====================================

;SYSTEM CONSTANTS

DMA	= $FE
BDOS	= $F0
FCB1	= $F6
DPH	= $F8
CCPV	= $DE
TPA	= $0200

DRIVE	= 0
TRK	= 1
SEC	= 2
ERRNO	= 3		;ERROR NR
RWFLAG	= 4		;READ/WRITE FLAG
MAXTRK	= 5		;MAX TRACKS
MAXSEC	= 6		;MAX SECTORS
SYSSECS = 7		;NR OF SYSTEM sectors
TRACK	= 8		;track buffer for form_trk
SIDEMS	= 9		;side bit
SECTOR	= 10		;sector nr
ERRCOD	= 13		;error nr buffer
RETRY	= 14		;retry counter

;BDOS COMMANDS

CONIN	= $01
CONOUT	= $02
STROUT	= $09
DSKSEL	= $0E
GETDRV	= $19
FBIOS	= $1A

;BIOS COMMANDS

CHRIN	= 3
HOME	= 8
SELDSK	= 9
SETSEC	= 11
READ	= 12
WRITE	= 13
GET_VER	= 15

;WD 2797 COMMANDS

RDSECC	= $88		;READ SECTOR
RSTORC	= $00		;restore, steprate 6 ms
SEEKC	= $18		;SEEK WITHOUT VERIFY, steprate 6 ms
WRTRKC	= $F0		;WRITE TRACK


;UDC-CONTROLLER ADDRESSES

UDC	= $F500
FDSEL	= UDC+$40	;MOTOR/SELECT DRIVE LATCH
FDSCR	= UDC+$50	;READ STATUS, WRITE COMMAND
FDTRG	= UDC+$51	;R/W TRACK REGISTER
FDSRG	= UDC+$52	;R/W SECTOR REGISTER
FDDAR	= UDC+$53	;R/W DATA REGISTER
FLSTAT	= UDC+$60	;IRQ --> BIT 7, DRQ --> BIT 6

;6532 ADDRESSES

SCRATCH	= $F600

STPRATE	= SCRATCH+$54		;Steprate $00: 6ms, $01: 12 ms
TIMER0	= SCRATCH+$71		;SYSTEM TIMER
TIMER1	= SCRATCH+$72		;8 BIT USER TIMER
TIMER2	= SCRATCH+$73		;16 BIT USER TIMER


;CONSTANTS

SELMSK	= $10		;MOTOR ON, DDEN ON

SPT	= 16		;SECTORS PER TRACK
MAXSECS	= 32		;Max. nr of system sectors
MAXTRY	= 10		;MAX TRIES ON ERROR


;CONTROL CODES

CR	= $0D
LF	= $0A
CLS	= $0C
SP	= $20
BREAK	= $03
EOT	= $00

;ERROR CODES

WRPROT	= $FC		;DISK WRITE PROTECTED
VER_ERR	= $83
SYSGERR = $85

;==========================================

	ORG TPA

	JSR INIT
	BCC SYSGEN
	JSR ERROR
	RTS

SYSGEN	JSR SYSDISK
	BCC FWEIT
	JSR ERROR
	BCC SYSGEN

FWEIT	LDA #REPM		;REPEAT?
	LDY #REPM/256
	JSR PRTSTR
	JSR YESNO
	BCC SYSGEN
EXIT	RTS


SYSDISK	JSR XCH_DSK		;INSERT A NEW DISC
	BCC SYSD1
	JSR ERROR
	JMP EXIT

SYSD1	LDA DRIVE
	LDY #SELDSK		;SELECT DRIVE
	JSR BIOS

ENDDSK	JSR PUT_SYS		;WRITE SYSTEM TO DISK
	BCS ENDDSKX
	LDA #OKM
	LDY #OKM/256
	JSR PRTSTR
	CLC
ENDDSKX	RTS


;======== SUBROUTINES =============

INIT	LDA #STARTM
	LDY #STARTM/256
	JSR PRTSTR
	LDY #GET_VER
	JSR BIOS
	CMP #$20
	BCC INITX
	LDX #GETDRV
	JSR BDOS
	CMP #5			;no SYSTEM on F: or higher
	BCS INIT1
	LDY #6			;SET DISK PARAMETERS
	LDA (DPH),Y
	STA MAXSEC
	LDY #13
	LDA (DPH),Y
	STA SYSSECS
	JSR GET_SYS
	RTS

INITX	LDA #VER_ERR
	SEC
	RTS

INIT1	LDA #SYSGERR
	SEC
	RTS


GET_SYS	LDA #0			;RESET RWFLAG AND DRIVE
	STA DRIVE
	STA RWFLAG
	BEQ SYS

PUT_SYS	LDA #$80		;SET RWFLAG
	STA RWFLAG

SYS	JSR RES_DMA
	LDA #0
	STA SECTOR
	STA SECTOR+1
	STA SECTOR+2
SYS1	JSR RW_SYS
	BCS SYS_X
	INC SECTOR		;System never larger than $FF sectors = 64 kB
	LDA SECTOR
	CMP SYSSECS
	BCC SYS1
	CLC
SYS_X	RTS



GETKEY	LDY #CHRIN		;TASTE EINLESEN
	JSR BIOS
	RTS


YESNO	JSR GETKEY		;J/N?
	JSR UPCASE
	CMP #'J
	BEQ YESNO1
	CMP #'Y
	BEQ YESNO1
	SEC
	RTS

YESNO1	CLC
	RTS


RW_SYS	LDY #SETSEC		;READ/WRITE SECTOR TO DMA
	LDA #SECTOR
	JSR BIOS
	BIT RWFLAG
	BMI RW_TRK2
	LDY #READ
	JSR BIOS
	BCS RW_TRKX
RW_TRK3	INC DMA+1
RW_TRKX	RTS

RW_TRK2	LDY #WRITE
	JSR BIOS
	BCC RW_TRK3
	RTS


RES_DMA	LDA #HEAP
	STA DMA
	LDA #HEAP/256
	STA DMA+1
	RTS


XCH_DSK	CLC
	LDY #0
	LDA (FCB1),Y
	BNE XCH_DSK1
	LDX #GETDRV
	JSR BDOS
	SEC

XCH_DSK1
	ADC #$40		;SET DRIVE NAME
	STA DRVCHR
	CMP #'F			;no System on F: or higher
	BCS XCHDSKX
	AND #$0F		;SET DRIVE
	TAY
	DEY
	STY DRIVE
	LDA #XCHGM
	LDY #XCHGM/256		;INSERT DISK
	JSR PRTSTR
	LDX #CONIN		;WAIT FOR KEY
	JSR BDOS
	JSR CRLF
	CLC
	RTS

XCHDSKX	LDA #SYSGERR
	SEC
	RTS


BIOS	LDX #FBIOS
	JMP BDOS


ERROR	STA ERRNO	;ERROR ROUTINE
	JSR CRLF
	LDA #ERRTAB	;SET CCPV
	STA CCPV
	LDA #ERRTAB/256
	STA CCPV+1
	LDY #0		;CHECK ERROR CODE
	LDA (CCPV),Y
ERROR1	BEQ ERROR4	;END OF ERROR ROUTINE
	CMP ERRNO
	BEQ ERROR3
ERROR2	JSR INCCPV	;SKIP ERROR MESSAGE
	BNE ERROR2
	JSR INCCPV
	JMP ERROR1

ERROR3	JSR INCCPV
	PHA
	JSR ERRTYP	;PRINT ERROR TYPE
	JSR INCCPV
	LDA CCPV	;PRINT ERROR MESSAGE
	LDY CCPV+1
	JSR PRTSTR
	PLA
	BPL ERROR5
	JSR ASKRTY	;ASK FOR RETRY
	LDA ERRNO
	RTS

ERROR4	JSR UETYP	;UNKNOWN ERROR
ERROR5	SEC
	RTS


ERRTYP	LDY #0		;PRINT ERROR TYPE
ERRTY1	LSR A		;SHIFT SOURCE BIT IN C
	BCS ERRTY2
	INY		;X=X+5
	INY
	INY
	INY
	INY
	BNE ERRTY1

ERRTY2	LDA ETYPTB,Y
	BEQ UETYP	;LAST CHR?
	JSR PRTCHR
	INY
	BNE ERRTY2

UETYP	LDA #ERRM1
	LDY #ERRM1/256
	JSR PRTSTR
	LDA ERRNO
	JSR PRTHEX

CRLF	LDA #CRLFM	;PRINTS A NEWLINE
	LDY #CRLFM/256

PRTSTR	LDX #STROUT
	JMP BDOS


PRT2SP	JSR PRTSP


PRTSP	LDA #SP


PRTCHR	LDX #CONOUT	;PRINTS A CHR
	JMP BDOS


INCCPV	INC CCPV	;INC CCPV
	BNE INCCP1
	INC CCPV+1
INCCP1	LDA (CCPV),Y
	RTS


UPCASE	CMP #'a
	BCC UPCASX
	CMP #$7F
	BCS UPCASX
	AND #$5F
UPCASX	RTS


ASKRTY	LDA #RTYMES	;RETRY?
	LDY #RTYMES/256
	JSR PRTSTR
	LDX #CONIN
	JSR BDOS
	JSR UPCASE
	CMP #'Y
	BNE ASKRT1
	CLC
	RTS

ASKRT1	SEC
	RTS


PRTDEC	JSR COMNUM	;PRINT DECIMAL
	PHA
	TYA
	JSR COMNUM
	PHA
	TYA
	JSR PRTNUM
	PLA
	JSR PRTNUM
	PLA		;PLA AND PRTNUM
PRTNUM	ORA #$30
	JMP PRTCHR


COMNUM	LDY #0		;DIV/10
COMNU1	SEC
	SBC #10
	BCC COMNU2
	INY
	BNE COMNU1

COMNU2	ADC #10
	RTS


PRTHEX	PHA		;PRINTS A HEX NUMBER
	LSR A
	LSR A
	LSR A
	LSR A
	JSR PRTNIB	;PRINT NIBBLE
	PLA
	AND #$0F

PRTNIB	CMP #$0A
	BCC PRTNI1
	ADC #6
PRTNI1	ADC #$30
	JSR PRTCHR
	RTS

;======	MESSAGES	======

SETAB	DB $FE,$08,$FF,$10		;SEEK ERROR
	DB $FA,$04,$FC,$40,$FD,$80	;WRITE TRACK ERROR

ERRM1	DB ' Error $',EOT
RTYMES	DB CR,LF,'Retry	(Y/N) ? ',EOT

ETYPTB	DB 'BIOS',$00,'BDOS',$00,'CCP',$00,$00
	DB 'RSX',$00,$00,'USER',$00

ERRTAB	DB $FF,$81,'Seek Error, record not found',EOT
	DB $FE,$81,'CRC Error',EOT
	DB $FD,$81,'Drive not ready',EOT
	DB $FC,$81,'Disk write protected',EOT
	DB $FB,$81,'Sector not found',EOT
	DB $FA,$81,'Lost data on writing track',EOT
	DB $F9,$01,'Invalid Drive',EOT
	DB $DE,$82,'Directory full',EOT
	DB $DD,$82,'File not found',EOT
	DB $DC,$02,'File exists',EOT
	DB $D9,$02,'Invalid FCB',EOT
	DB $D8,$82,'Disk full',EOT
	DB $D6,$82,'File is R/O',EOT
	DB $85,$10,'No System on this Drive',EOT
	DB $83,$10,'BIOS Version lower than 2.2',EOT
	DB $82,$10,'Illegal Parameter',EOT
	DB $81,$10,'Missing Parameter',EOT

	DB $00

STARTM	DB CLS
	DB 'SYSGEN V',VERSION/16+$30,'.',VERSION*$1000/$1000+$30
	DB '			(c) D. Lausberg	2021'
	DB CR,LF,CR,LF,EOT
XCHGM	DB CR,LF,'Diskette in Drive '
DRVCHR	DB 'B: einlegen'
	DB CR,LF,'und Taste druecken'
	DB CR,LF,CR,LF
	DB 'Abbruch mit <CTRL-C>',CR,LF,CR,LF,EOT

OKM	DB CR,LF,'System kopiert',EOT
REPM	DB CR,LF,'Eine weitere Diskette?  <Y/N> ',EOT

CRLFM	DB CR,LF,EOT

HEAP

ENDE	END

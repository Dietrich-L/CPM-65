( I2C routines for DS3231 and AT 24C32   D. Lausberg 7.6.21 )   HEX                                                             : I2C ." I2C routines " CR ;   ( mark for forget )              F680 constant DRA            F681 constant PADD                 F682 constant DRB            F683 constant PBDD                                                                                 AE constant 24c32W           AF constant 24c32R                 D0 constant ds3231W          D1 constant ds3231R                1 variable D-BUF                                                                                                                : I2C-INIT PADD C@ 01 or PADD C! ;                                                                                              : .B HEX 0 <# # #S #> Type ;                                    : .W HEX 0 <# # # # #S #> Type ;                                -->                                                                                                                             ( I2C routines for DS3231 and AT 24C32             SCR# 4   )   : D-UP PBDD c@ BF and PBDD c! ;                                 : D-DN DRB C@ BF and DRB C! PBDD c@ 40 or PBDD C! ;             : CLK-UP DRA c@ 01 or DRA c! ;                                  : CLK-DN DRA c@ FE and DRA c! ;                                 : D-IN DRB c@ 40 and ;                                          : I2C-Start D-UP CLK-UP D-DN CLK-DN ;                           : I2C-STOP D-DN CLK-UP D-UP ;                                   : I2C-ACK D-DN CLK-UP CLK-DN D-UP ;                             : I2C-NAK D-UP CLK-UP CLK-DN ;                                                                                                  : CLR-I2C I2C-STOP I2C-Start D-UP 9 0 do CLK-UP CLK-DN LOOP         I2C-Start I2C-Stop ;                                        : ?ACK D-UP CLK-UP D-IN CLK-DN ;                                                                                                -->                                                             ( I2C routines for DS3231 and AT 24C32             SCR# 5   )   : ?ok if cr ."  NAK occured" cr abort endif ;                   : RESET-I2C I2C-InIT CLR-I2C ;                                  : S-Byte  ( byte - f ) D-DN CLK-DN                                 8 0 do dup 80 and if D-UP else D-DN endif                              CLK-UP CLK-DN 2 * 0FF and loop drop ?ACK ;            : S-nDB ( b1..bn n - ) 0 do S-Byte drop loop I2C-Stop ;         : R-Byte  (  - byte )  D-UP 0                                      8 0 do CLK-UP D-IN CLK-DN if 1 + endif 2 * loop 2 / ;        : R-lDB R-Byte I2C-NAK I2C-STOP ;                               : R-nDB ( n - b1..bn ) 1 - 0 do R-Byte I2C-ACK loop R-lDB ;                                                                     : RTC-R I2C-Start DS3231R S-Byte drop ;                         : Wait ( adr -  ) begin i2c-start s-byte ?terminal                  if abort endif 0= until I2C-Stop ;                          -->                                                             ( I2C routines for AT 24C32                   SCR# 6   )        : S-EEPROM-ADR ( MEM -  ) ( MEM 16 Bit EEPROM adr )                 24C32W dup Wait I2C-Start S-Byte drop dup 100 / S-Byte          drop 0FF and S-Byte drop ;                                  : R-EEPROM I2C-Start 24C32R S-Byte drop ;                                                                                       : Dump-EEPROM ( page - ) cr 100 * dup S-EEPROM-adr R-EEPROM         hex 10 0 do dup I 10 * + .W ." : "                                  10 0 do R-Byte I2C-Ack .B ."  " loop cr loop drop           R-lDB drop cr ;                                                                                                                                                                                                                                             -->                                                                                                                                                                                             ( I2C routines for DS3231                     SCR# 7   )        : S-RTC-Adr ( Register -   )  DS3231W dup                             wait I2C-Start s-Byte drop s-Byte drop ;                                                                                  : Set-Time ( hh mm ss - ) ( 24h Format )                             0 S-RTC-ADR 3 S-nDB ;                                      : Set-Date ( yy mm dd wd -  ) ( wd 1 = Monday )                      3 S-RTC-ADR 4 S-nDB ;                                      : SET-RTC ( reset ALM, CR, SR ) 7 S-RTC-ADR                          9 0 do 0 S-Byte drop loop I2C-Stop ;                                                                                       -->                                                                                                                                                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 8   )   : .WD ( wd -  ) dup 1 = if ." Montag" endif                                     dup 2 = if ." Dienstag" endif                                   dup 3 = if ." Mittwoch" endif                                   dup 4 = if ." Donnerstag" endif                                 dup 5 = if ." Freitag" endif                                    dup 6 = if ." Samstag" endif                                        7 = if ." Sonntag" endif                         ." , den " ;                                                                                                               : .temp 11 s-rtc-adr rtc-r 2 r-ndb cr ." Temperatur: "              decimal swap 2 .r ." ," 16 / . ." Grad" cr ;                                                                                -->                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 9   )   : SCAN-I2C RESET-I2C 100 0 do I2C-Start I S-Byte                     if   else hex cr ." I2C Adr : " I  2 / .B ."  W: " I .B         ."  R: " I 1+ .B endif I2C-STOP 2 +loop cr ;               : R-Time (  - ss mm hh ) 0 S-RTC-ADR RTC-R 3 R-nDB ;            : R-Date (  - wd dd mm yy ) 3 S-RTC-ADR RTC-R 4 R-nDB ;                                                                                                                                         : .Time R-Time cr ." Uhrzeit: " .B ." :" .B ." :" .B CR ;       : .Date R-Date >R >R >R cr .WD R> .B ." ." R> .B ." ." R>               .B cr ;                                                                                                                 -->                                                                                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 10  )                                                                   decimal                                                         latest 12 +origin !                                             here 30 +Origin !                                                                                                               ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( I2C routines for DS3231 and AT 24C32   D. Lausberg 7.6.21 )   HEX                                                             : I2C ." I2C routines " CR ;   ( mark for forget )              F680 constant DRA            F681 constant PADD                 F682 constant DRB            F683 constant PBDD                                                                                 AE constant 24c32W           AF constant 24c32R                 D0 constant ds3231W          D1 constant ds3231R                1 variable D-BUF                                                                                                                : I2C-INIT PADD C@ 01 or PADD C! ;                                                                                              : .B HEX 0 <# # #S #> Type ;                                    : .W HEX 0 <# # # # #S #> Type ;                                -->                                                                                                                             ( I2C routines for DS3231 and AT 24C32             SCR# 4   )   : D-UP PBDD c@ BF and PBDD c! ;                                 : D-DN DRB C@ BF and DRB C! PBDD c@ 40 or PBDD C! ;             : CLK-UP DRA c@ 01 or DRA c! ;                                  : CLK-DN DRA c@ FE and DRA c! ;                                 : D-IN DRB c@ 40 and ;                                          : I2C-Start D-UP CLK-UP D-DN CLK-DN ;                           : I2C-STOP D-DN CLK-UP D-UP ;                                   : I2C-ACK D-DN CLK-UP CLK-DN D-UP ;                             : I2C-NAK D-UP CLK-UP CLK-DN ;                                                                                                  : CLR-I2C I2C-STOP I2C-Start D-UP 9 0 do CLK-UP CLK-DN LOOP         I2C-Start I2C-Stop ;                                        : ?ACK D-UP CLK-UP D-IN CLK-DN ;                                                                                                -->                                                             ( I2C routines for DS3231 and AT 24C32             SCR# 5   )   : ?ok if cr ."  NAK occured" cr abort endif ;                   : RESET-I2C I2C-InIT CLR-I2C ;                                  : S-Byte  ( byte - f ) D-DN CLK-DN                                 8 0 do dup 80 and if D-UP else D-DN endif                              CLK-UP CLK-DN 2 * 0FF and loop drop ?ACK ;            : S-nDB ( b1..bn n - ) 0 do S-Byte drop loop I2C-Stop ;         : R-Byte  (  - byte )  D-UP 0                                      8 0 do CLK-UP D-IN CLK-DN if 1 + endif 2 * loop 2 / ;        : R-lDB R-Byte I2C-NAK I2C-STOP ;                               : R-nDB ( n - b1..bn ) 1 - 0 do R-Byte I2C-ACK loop R-lDB ;                                                                     : RTC-R I2C-Start DS3231R S-Byte drop ;                         : Wait ( adr -  ) begin i2c-start s-byte ?terminal                  if abort endif 0= until I2C-Stop ;                          -->                                                             ( I2C routines for AT 24C32                   SCR# 6   )        : S-EEPROM-ADR ( MEM -  ) ( MEM 16 Bit EEPROM adr )                 24C32W dup Wait I2C-Start S-Byte drop dup 100 / S-Byte          drop 0FF and S-Byte drop ;                                  : R-EEPROM I2C-Start 24C32R S-Byte drop ;                                                                                       : Dump-EEPROM ( page - ) cr 100 * dup S-EEPROM-adr R-EEPROM         hex 10 0 do dup I 10 * + .W ." : "                                  10 0 do R-Byte I2C-Ack .B ."  " loop cr loop drop           R-lDB drop cr ;                                                                                                                                                                                                                                             -->                                                                                                                                                                                             ( I2C routines for DS3231                     SCR# 7   )        : S-RTC-Adr ( Register -   )  DS3231W dup                             wait I2C-Start s-Byte drop s-Byte drop ;                                                                                  : Set-Time ( hh mm ss - ) ( 24h Format )                             0 S-RTC-ADR 3 S-nDB ;                                      : Set-Date ( yy mm dd wd -  ) ( wd 1 = Monday )                      3 S-RTC-ADR 4 S-nDB ;                                      : SET-RTC ( reset ALM, CR, SR ) 7 S-RTC-ADR                          9 0 do 0 S-Byte drop loop I2C-Stop ;                                                                                       -->                                                                                                                                                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 8   )   : .WD ( wd -  ) dup 1 = if ." Montag" endif                                     dup 2 = if ." Dienstag" endif                                   dup 3 = if ." Mittwoch" endif                                   dup 4 = if ." Donnerstag" endif                                 dup 5 = if ." Freitag" endif                                    dup 6 = if ." Samstag" endif                                        7 = if ." Sonntag" endif                         ." , den " ;                                                                                                               : .temp 11 s-rtc-adr rtc-r 2 r-ndb cr ." Temperatur: "              decimal swap 2 .r ." ," 16 / . ." Grad" cr ;                                                                                -->                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 9   )   : SCAN-I2C RESET-I2C 100 0 do I2C-Start I S-Byte                     if   else hex cr ." I2C Adr : " I  2 / .B ."  W: " I .B         ."  R: " I 1+ .B endif I2C-STOP 2 +loop cr ;               : R-Time (  - ss mm hh ) 0 S-RTC-ADR RTC-R 3 R-nDB ;            : R-Date (  - wd dd mm yy ) 3 S-RTC-ADR RTC-R 4 R-nDB ;                                                                                                                                         : .Time R-Time cr ." Uhrzeit: " .B ." :" .B ." :" .B CR ;       : .Date R-Date >R >R >R cr .WD R> .B ." ." R> .B ." ." R>               .B cr ;                                                                                                                 -->                                                                                                                                                                                                                                                             ( I2C routines for DS3231                          SCR# 10  )                                                                   decimal                                                         latest 12 +origin !                                             here 30 +Origin !                                                                                                               ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              